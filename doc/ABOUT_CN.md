# 关于 budva43 项目

## 项目描述

**budva43** 是一个用 Go 语言编写的智能 Telegram 消息自动转发系统。该项目是一个企业级解决方案，实现了 UNIX-way 原则和清洁架构，用于从各种频道和群组的消息中创建主题摘要。

## 核心功能

### 自动消息转发
- **转发 (Forward)** — 发送消息时保留原始作者身份
- **发送副本 (Send Copy)** — 创建消息副本而不显示原始来源
- **媒体相册支持** — 处理群组图片和文件

### 过滤系统
- **排除过滤器** — 使用正则表达式阻止不需要的内容
- **包含过滤器** — 只允许相关消息通过的规则
- **子字符串过滤器** — 使用正则表达式组精确过滤子字符串
- **自动回复** — 对带键盘的消息自动回复
- **特殊聊天** — 自动发送过滤后的消息到检查/其他频道

### 内容转换
- **链接替换** — 自动替换指向目标聊天中自己消息的链接
- **外部链接删除** — 清理指向外部来源的链接
- **文本片段替换** — 为不同接收者自定义文本转换
- **来源签名** — 标明原始消息来源
- **来源链接生成** — 自动添加指向原始消息的链接

### 消息生命周期管理
- **仅复制一次 (Copy Once)** — 单次发送，编辑时不同步
- **不可删除 (Indelible)** — 原始消息删除时保护消息不被删除
- **编辑同步** — 原始消息更改时自动更新复制的消息
- **删除同步** — 源消息删除时删除副本

### 附加功能
- **速率限制** — 控制发送速度以防止被封禁
- **系统消息处理** — 自动删除服务通知

## 架构

### 微服务结构
项目分为两个主要服务：

#### 引擎 (cmd/engine)
- **用途**：执行消息转发
- **限制**：禁止向传出聊天发送新消息
- **组件**：Telegram 更新处理器、转发和过滤服务

#### 门面 (cmd/facade)  
- **用途**：提供 API（GraphQL、gRPC、REST）
- **功能**：完全访问消息发送功能
- **接口**：Web 界面、gRPC API、终端界面

### 分层架构

```
传输层 (Transport Layer)    → HTTP、gRPC、终端、Telegram Bot API
服务层 (Service Layer)      → 业务逻辑、转发规则处理
仓储层 (Repository Layer)   → TDLib、存储、队列
领域层 (Domain Layer)       → 数据模型、转发规则
```

### 设计模式
- **清洁架构** — 责任层的清晰分离
- **依赖注入** — 自定义依赖注入系统
- **仓储模式** — 数据访问抽象
- **观察者模式** — Telegram 更新处理

## 技术栈

### 核心技术
- **Go 1.24** — 支持泛型的主要开发语言
- **TDLib** — Telegram 客户端应用官方库
- **BadgerDB** — 嵌入式 NoSQL 数据库

### API 和传输
- **gRPC** — 用于集成的高性能 API
- **GraphQL** — 用于 Web 客户端的灵活 API  
- **REST** — 经典 HTTP API
- **Telegram Client API** — 与 Telegram 直接交互
- **终端界面** — 交互式终端界面

### 开发和测试
- **Docker 和 DevContainers** — 开发容器化
- **Testcontainers** — 集成测试（包括 Redis 连接测试）
- **Mockery** — 模拟对象生成
- **Godog (BDD)** — 行为驱动测试
- **GitHub Actions CI** — 自动化持续集成

### 监控和可观测性
- **结构化日志** — 使用 slog 的结构化日志记录
- **Grafana + Loki** — 集中式日志和监控
- **pplog** — 开发用的人类可读 JSON 日志
- **spylog** — 测试中的日志拦截

### 构建和开发工具
- **Task** — Make 的替代品，用于任务自动化
- **golangci-lint** — 综合代码质量检查
- **自定义 Linter** — "error-log-or-return" 和 "unused-interface-methods"
- **protobuf** — gRPC 接口生成
- **jq** — 实时日志查看和过滤
- **EditorConfig** — 编辑器设置一致性

## 开发原则

### 架构原则
- **SOLID** — 应用所有五个面向对象编程原则
- **DRY** — 避免代码重复，但不过分
- **KISS** — 偏好简单解决方案而非复杂方案
- **YAGNI** — 只实现必要的功能

### Go 特定方法
- **CSP（通信顺序进程）** — 使用通道而不是互斥锁
- **接口分离** — 在消费模块中使用本地接口
- **接受接口，返回结构体** — 惯用的接口工作方式
- **提前返回** — 减少代码嵌套
- **表驱动测试** — 结构化测试

### 错误处理约定
- **结构化错误** — 带有自动调用栈的结构化错误
- **记录或返回** — 要么记录错误，要么向上返回
- **最小包装** — 只在添加上下文时包装错误

## 配置

### 设置层次结构
```
defaultConfig() → config.yml → .env
```

### 配置类型
- **静态配置** — 基本应用程序设置
- **动态配置** — 支持热重载的转发规则
- **机密数据** — 通过环境变量的 API 密钥和令牌

### 转发配置示例
```yaml
forward_rules:
  rule1:
    from: 1001234567890
    to: [1009876543210, 1001111111111]
    send_copy: true
    exclude: "EXCLUDE|spam"
    include: "IMPORTANT|urgent"
    copy_once: false
    indelible: true
```

## 测试

### 多层次测试
- **单元测试** — 使用模拟对象的隔离组件测试
- **集成测试** — 组件交互测试
- **端到端测试** — 通过 gRPC API 的完整用户场景
- **BDD 测试** — 用自然语言描述行为
- **快照测试** — 使用参考快照的测试

### 特殊技术
- **同步测试** — 时间和并发测试
- **调用驱动测试** — 带有准备函数的表格测试
- **间谍日志** — 测试中的日志拦截和验证

### 测试覆盖率
- **Codecov.io 集成** — 自动代码覆盖率跟踪
- **集成测试覆盖率** — 专门工具
- **功能覆盖率** — 所有关键使用场景
- **技术覆盖率** — 内部函数和边界情况
- **BDD 场景** — 用户故事和业务规则

## 部署和运维

### 启动选项
- **本地开发** — 在主机上直接安装 TDLib
- **DevContainer** — 完全隔离的开发环境
- **生产环境** — 容器化部署

### 监控和调试
- **结构化日志** — 用于机器处理的 JSON 日志
- **人类可读日志** — 开发用的 pplog
- **健康检查** — 服务状态检查
- **优雅关闭** — 正确的工作终止

### 集成
- **Telegram 客户端** — 带授权的全功能客户端
- **外部 API** — 通过 GraphQL、gRPC、REST 集成
- **消息队列** — 异步消息处理

## 贡献开发

### 项目理念
Budva43 定位为"我最好的学习项目，用于应用技术——从 MVP 到企业级"。该项目展示了现代 Go 开发方法，包括最新的语言特性和行业最佳实践。

### 独特特性
- **实验性方法** — 使用前沿的 Go 功能
- **全面测试** — 完整的测试技术谱系
- **生产就绪质量** — 准备好用于工业使用
- **教育特色** — 丰富的文档和示例

该项目正在积极开发中，并作为现代 Go 在企业开发中能力的展示。 